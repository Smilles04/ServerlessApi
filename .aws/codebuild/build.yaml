version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.13
    commands:
      - pip install aws-sam-cli --upgrade
      - sam --version

  pre_build:
    commands:
      - echo "Validating SAM app template..."
      - sam validate --template template.yaml

  build:
    commands:
      - echo "Building SAM app..."
      - sam build --template template.yaml --build-dir build

  post_build:
    commands:
      - echo "Packaging SAM app..."
      - >
        sam package
        --template-file build/template.yaml
        --output-template-file packaged.yaml
        --s3-bucket $CODEPIPELINE_S3_BUCKET
        --region $AWS_DEFAULT_REGION
        --s3-prefix "${PROJECT_ID}/${APPLICATION_ID}/${STAGE}/SAMArtifacts"
        --kms-key-id "${KMS_KEY_ID}"
      - echo "Generating params.json..."
      - echo "{\"Parameters\": {\"Environment\": \"$STAGE\"}}" > params.json

artifacts:
  files:
    - packaged.yaml
    - params.json
  discard-paths: no
